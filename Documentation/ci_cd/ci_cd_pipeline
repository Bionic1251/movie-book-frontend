# Current CI/CD pipeline

## With every push, the main.yml will:

- Sign in to Dockerhub via secret credentials set up in repository

- Build a new docker image from frontend folder

- Push the new image to Dockerhub

## To deploy new image to production

!DISCLAIMER! Following these steps WILL stop the production version of the app to close down for a moment. If a new image is somehow corrupted, run the old image to keep the app functioning.

1. Connect to the cPouta virtual machine via ssh. [instructions here](https://github.com/movie-book-recommender/movie-book-recommender-project/blob/main/Documentation/instructions/cpouta.md)

2. Pull new image from dockerhub by running:
    ```
        sudo docker pull evahteri/movie-book-recommender:container2
    ```
3. Kill the earlier container from running:

- Check the running containers with:
    ```
        sudo docker container ls
    ```
    and check the container id for the next step

- Shut down the container with:
    ```
        sudo docker container kill {CONTAINER ID}
    ```

4. Start the updated image:

- Check downloaded images with:
    ```
        sudo docker image ls
    ```
- Start the new image with:
    ```
        sudo docker run -d -p 5000:5000 {IMAGE ID}
    ```

5. (optional) Remove the old image with:
    ```
        sudo docker image rm -f {IMAGE ID}
    ```
    Don't do this until you are sure that new image works flawlessy.

### Something wrong with the new image? Go back to the old one

Kill the running container first with step 3 of earlier instruction.

1. Check downloaded images with:
    ```
        sudo docker image ls
    ```
2. Check the IMAGE ID of the earlier image, you can see the creation times in column CREATED

3. Start the old image with:
    ```
        sudo docker run -d -p 5000:5000 {IMAGE ID}
    ```

## Future CD pipeline implementation

Using a watchtower container to automatically check and update and start new version of the image.